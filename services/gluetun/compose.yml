name: gluetun

services:
  gluetun:
    container_name: gluetun
    image: qmcgaw/gluetun:latest
    restart: unless-stopped
    user: "0:0"  # Run as root (required for VPN operations)

    # VPN requires special capabilities and devices
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun

    # Expose ports for services that will use this VPN container
    ports:
      - "8112:8112"  # Deluge WebUI
      - "58846:58846"  # Deluge daemon
      - "9696:9696"  # Prowlarr (if routing through VPN)

    volumes:
      - ./data:/gluetun:rw

    environment:
      # VPN Provider Configuration
      - VPN_SERVICE_PROVIDER=private internet access
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${PIA_USERNAME}
      - OPENVPN_PASSWORD=${PIA_PASSWORD}
      - SERVER_REGIONS=${VPN_REGION:-US West}

      # Security: Kill switch (block traffic if VPN disconnects)
      - FIREWALL_VPN_INPUT_PORTS=${FIREWALL_VPN_INPUT_PORTS:-}
      - FIREWALL_INPUT_PORTS=${FIREWALL_INPUT_PORTS:-}
      - FIREWALL_OUTBOUND_SUBNETS=${FIREWALL_OUTBOUND_SUBNETS:-192.168.68.0/24}

      # Timezone
      - TZ=${TZ:-America/Los_Angeles}

      # Health check server
      - HEALTH_SERVER_ADDRESS=:9999

    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    sysctls:
      # Required for some VPN providers
      - net.ipv4.conf.all.src_valid_mark=1

networks:
  default:
    name: gluetun_network
    external: false
